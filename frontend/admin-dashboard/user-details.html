<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Event Ease ‚Äî User Details</title>

		<!-- Fonts & Bootstrap (match users.html) -->
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>

		<!-- Global design system CSS (keeps visual parity) -->
		<link rel="stylesheet" href="../style.css" />
		<link rel="stylesheet" href="admin-common.css" />

		<style>
			/* keep the look consistent with users.html */
			body {
				background: var(--bg-light);
				color: var(--text-dark);
				font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
					"Helvetica Neue", Arial;
			}
			.app-shell {
				height: calc(100vh - var(--header-height));
				overflow: hidden;
			}
			.app-main {
				flex: 1;
				padding: 32px;
				height: 100%;
				overflow-y: auto;
				background: var(--bg-light);
			}
			.page-header {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				gap: 16px;
				margin-bottom: 18px;
			}

			/* Details card */
			.details-card {
				border-radius: 12px;
				padding: 22px;
				background: var(--bg-surface);
				box-shadow: var(--shadow);
				border: 1px solid #e4e8f0;
			}

			.avatar-circle {
				width: 110px;
				height: 110px;
				border-radius: 999px;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 2.25rem;
				color: white;
				background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
			}

			.label {
				font-size: 13px;
				color: var(--muted, #6b7280);
				text-transform: uppercase;
				letter-spacing: 0.6px;
				margin-bottom: 6px;
			}
			.value {
				font-weight: 700;
				font-size: 16px;
			}

			.meta {
				color: var(--muted, #6b7280);
				font-size: 14px;
			}

			.status-chip {
				display: inline-flex;
				align-items: center;
				gap: 8px;
				padding: 8px 12px;
				border-radius: 999px;
				font-weight: 700;
			}
			.status-active {
				background: var(--success-light, #dff7e8);
				color: #065f46;
			}
			.status-inactive {
				background: var(--danger-light, #fff1f2);
				color: #7f1d1d;
			}

			.info-row {
				padding: 10px 0;
				border-bottom: 1px dashed rgba(0, 0, 0, 0.03);
			}
			.info-row:last-child {
				border-bottom: none;
			}

			.actions .btn {
				min-width: 120px;
			}

			@media (max-width: 991px) {
				.app-main {
					padding: 20px;
				}
				.page-header {
					flex-direction: column;
				}
			}
		</style>
	</head>

	<body>
		<!-- TOPBAR (keeps same structure so UI matches exactly) -->
		<header class="topbar" role="banner">
			<div class="d-flex align-items-center gap-3">
				<button
					class="menu-toggle d-lg-none"
					id="sidebarToggle"
					aria-label="Open navigation"
				>
					‚ò∞
				</button>
				<a
					href="admin.html"
					class="d-flex align-items-center text-decoration-none"
					aria-label="Event Ease Home"
				>
					<div class="logo"><img src="../logo.svg" alt="EE" /></div>
					<div
						style="
							margin-left: 10px;
							font-weight: 700;
							color: var(--text-dark);
						"
					>
						Event Ease
					</div>
				</a>
			</div>

			<div class="d-flex align-items-center gap-3">
				<div class="d-none d-md-block" style="min-width: 260px">
					<input
						id="globalSearchTop"
						class="form-control form-control-sm"
						placeholder="Search (users, emails, ids) ‚Äî /"
						aria-label="Global search"
						disabled
					/>
				</div>

				<div class="dropdown">
					<button
						class="btn d-flex align-items-center gap-2"
						data-bs-toggle="dropdown"
						aria-expanded="false"
					>
						<div
							class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
							style="width: 36px; height: 36px"
						>
							AD
						</div>
						<div class="d-none d-md-block text-start">
							<div style="font-weight: 600">Admin</div>
							<div class="muted small">admin@college.edu</div>
						</div>
					</button>
					<ul class="dropdown-menu dropdown-menu-end">
						<li>
							<a class="dropdown-item" href="profile.html"
								>Profile</a
							>
						</li>
						<li>
							<a class="dropdown-item" href="settings.html"
								>Settings</a
							>
						</li>
						<li><hr class="dropdown-divider" /></li>
						<li>
							<button
								class="dropdown-item text-danger"
								id="logoutTop"
							>
								Logout
							</button>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div class="app-shell d-flex">
			<!-- SIDEBAR (minimal, same links) -->
			<aside
				class="app-sidebar d-none d-lg-flex"
				id="sidebar"
				role="navigation"
				aria-label="Main navigation"
			>
				<nav class="sidebar-nav" role="menu">
					<a href="admin.html">üè† Home</a>
					<a href="users.html" class="active" aria-current="page"
						>üë• Users</a
					>
					<a href="events.html">üìÖ Events</a>
					<a href="add-event.html">‚ûï Add Event</a>
					<a href="reports.html">üìä Reports</a>
					<a href="profile.html">üë§ Profile</a>
				</nav>

				<div class="sidebar-footer">
					<a
						class="text-danger"
						href="#"
						id="logoutSide"
						style="display: block; margin-bottom: 12px"
						>üîí Logout</a
					>
					<div>v1.0 ‚Ä¢ ¬© <span id="yrDetails"></span></div>
				</div>
			</aside>

			<!-- MAIN -->
			<main class="app-main" id="main" role="main">
				<div class="page-header">
					<div>
						<h3 id="pageTitle">User details</h3>
						<div class="muted">
							View and manage user account, status and contact.
						</div>
					</div>

					<div class="d-flex gap-2 align-items-center">
						<a
							href="users.html"
							class="btn btn-outline btn-sm"
							id="backToList"
							>‚Üê Back</a
						>
						<button
							class="btn btn-primary btn-sm"
							id="editOnDetails"
						>
							Edit user
						</button>
					</div>
				</div>

				<div class="details-card">
					<div id="userDetailsRoot" class="container-fluid">
						<!-- rendered by JS -->
						<div class="text-center py-5 text-muted">
							Loading user...
						</div>
					</div>
				</div>

				<div class="mt-3">
					<div class="muted small">
						Tip: You can toggle active state, send email, edit or
						delete this user. Changes are demo-only unless you hook
						up an API.
					</div>
				</div>
			</main>
		</div>

		<!-- Bootstrap JS -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			// keep year consistent with user.html
			document.getElementById("yrDetails").textContent =
				new Date().getFullYear();

			// Demo fallback users (same structure as users.html demo)
			const fallbackUsers = [
				{
					id: "U001",
					name: "Asha Sharma",
					email: "asha@college.edu",
					role: "student",
					active: true,
					lastActive: "2025-12-04T09:30:00Z",
					phone: "+91-98xxxx",
					department: "CSE",
					createdAt: "2024-08-12",
				},
				{
					id: "U002",
					name: "Ravi Patel",
					email: "ravi@college.edu",
					role: "teacher",
					active: true,
					lastActive: "2025-12-03T14:10:00Z",
					phone: "+91-98xxxx",
					department: "ME",
					createdAt: "2023-11-20",
				},
				{
					id: "U003",
					name: "Meera Singh",
					email: "meera@college.edu",
					role: "coordinator",
					active: false,
					lastActive: "2025-11-28T11:55:00Z",
					phone: "+91-98xxxx",
					department: "EC",
					createdAt: "2022-04-05",
				},
				{
					id: "U004",
					name: "Dev Admin",
					email: "admin@college.edu",
					role: "admin",
					active: true,
					lastActive: "2025-12-05T08:10:00Z",
					phone: "+91-98xxxx",
					department: "Admin",
					createdAt: "2022-01-01",
				},
			];

			// Demo: current admin id (same check as users.html)
			const CURRENT_ADMIN_ID = "U004";

			// Helpers (same patterns as users.html)
			function getQueryParam(name) {
				return new URLSearchParams(window.location.search).get(name);
			}
			function escapeHtml(text) {
				if (text === undefined || text === null) return "";
				return String(text)
					.replaceAll("&", "&amp;")
					.replaceAll("<", "&lt;")
					.replaceAll(">", "&gt;")
					.replaceAll('"', "&quot;")
					.replaceAll("'", "&#039;");
			}
			function initials(name) {
				if (!name) return "";
				const parts = name.trim().split(/\s+/);
				return (
					(parts[0]?.[0] || "") +
					(parts.length > 1 ? parts[parts.length - 1]?.[0] || "" : "")
				);
			}
			function formatLastActive(iso) {
				const d = new Date(iso);
				if (Number.isNaN(d.getTime())) return "‚Äî";
				return `${d.toLocaleDateString(undefined, {
					month: "short",
					day: "numeric",
					year: "numeric",
				})} ‚Ä¢ ${d.toLocaleTimeString([], {
					hour: "2-digit",
					minute: "2-digit",
				})}`;
			}
			function capitalize(s) {
				return s ? s[0].toUpperCase() + s.slice(1) : s;
			}

			// Load user from sessionStorage or query param, fallback to sample
			function loadUser() {
				let user = null;
				const stored = sessionStorage.getItem("selectedUser");
				if (stored) {
					try {
						user = JSON.parse(stored);
					} catch (e) {
						user = null;
					}
				}
				if (!user) {
					const id = getQueryParam("id");
					if (id) {
						// In a real app: fetch(`/api/users/${id}`)
						user = fallbackUsers.find((u) => u.id === id);
					}
				}
				// final fallback: first sample user
				if (!user) user = fallbackUsers[0];
				return user;
			}

			// Render details UI (matching styles) ‚Äî includes Delete button
			function renderUserDetails(user) {
				const root = document.getElementById("userDetailsRoot");
				if (!user) {
					root.innerHTML = `<div class="text-center py-5 text-muted">User not found.</div>`;
					return;
				}

				const statusClass = user.active
					? "status-active"
					: "status-inactive";
				root.innerHTML = `
          <div class="row g-3">
            <div class="col-lg-4 text-center">
              <div class="avatar-circle mb-3">${escapeHtml(
					initials(user.name)
				)}</div>
              <div class="h5 mb-0">${escapeHtml(user.name)}</div>
              <div class="meta">${escapeHtml(user.email)}</div>
              <div class="mt-3"><span class="status-chip ${statusClass}">${
					user.active ? "Active" : "Deactivated"
				}</span></div>
            </div>

            <div class="col-lg-8">
              <div class="info-row row">
                <div class="col-6">
                  <div class="label">User ID</div>
                  <div class="value">${escapeHtml(user.id)}</div>
                </div>
                <div class="col-6">
                  <div class="label">Role</div>
                  <div class="value"><span class="role-chip" data-role="${escapeHtml(
						user.role
					)}">${escapeHtml(capitalize(user.role))}</span></div>
                </div>
              </div>

              <div class="info-row row">
                <div class="col-6">
                  <div class="label">Department</div>
                  <div class="value">${escapeHtml(user.department || "‚Äî")}</div>
                </div>
                <div class="col-6">
                  <div class="label">Phone</div>
                  <div class="value">${escapeHtml(user.phone || "‚Äî")}</div>
                </div>
              </div>

              <div class="info-row row">
                <div class="col-6">
                  <div class="label">Last active</div>
                  <div class="value">${formatLastActive(user.lastActive)}</div>
                </div>
                <div class="col-6">
                  <div class="label">Created</div>
                  <div class="value">${escapeHtml(user.createdAt || "‚Äî")}</div>
                </div>
              </div>

              <div class="mt-3 actions d-flex flex-wrap gap-2">
                <a href="mailto:${encodeURIComponent(
					user.email
				)}" class="btn btn-outline-primary">Send email</a>
                <button class="btn btn-outline-secondary" id="toggleActiveBtn">${
					user.active ? "Deactivate" : "Activate"
				}</button>
                <button class="btn btn-primary" id="editBtn">Edit</button>
                <button class="btn btn-danger" id="deleteBtn">Delete</button>
                <a class="btn btn-outline" href="users.html">Back to list</a>
              </div>
            </div>
          </div>
        `;

				// hook buttons
				document
					.getElementById("toggleActiveBtn")
					.addEventListener("click", () => {
						// Demo: toggle locally and persist to sessionStorage
						user.active = !user.active;
						sessionStorage.setItem(
							"selectedUser",
							JSON.stringify(user)
						);
						// If you use API: call PATCH /api/users/:id here and show a toast on success/failure
						renderUserDetails(user);
					});

				document
					.getElementById("editBtn")
					.addEventListener("click", () => {
						// Redirect to users list where edit modal exists; store selectedUser for prefill
						sessionStorage.setItem(
							"selectedUser",
							JSON.stringify(user)
						);
						// You can have users.html open edit modal on load if it finds selectedUser
						window.location.href = "edit-user.html";
					});

				document
					.getElementById("deleteBtn")
					.addEventListener("click", () => {
						handleDelete(user);
					});
			}

			/**
			 * Delete logic:
			 * - Prevent deleting the currently logged-in admin from this UI.
			 * - If a 'users' array exists in sessionStorage (e.g. users page persisted it), respect admin-count rules.
			 * - Otherwise ask for a strong confirmation and set 'deletedUserId' in sessionStorage so users.html
			 *   can remove it (or you can replace this with an API call).
			 */
			function handleDelete(user) {
				if (!user) return;

				// Prevent self-delete
				if (user.id === CURRENT_ADMIN_ID) {
					return alert(
						"You cannot delete your own admin account from this interface."
					);
				}

				// Try to read users list from sessionStorage (optional integration)
				let storedUsers = null;
				try {
					storedUsers = JSON.parse(
						sessionStorage.getItem("users") || "null"
					);
				} catch (e) {
					storedUsers = null;
				}

				// If we have a users list, enforce admin deletion safeguards
				if (Array.isArray(storedUsers)) {
					if (user.role === "admin") {
						const otherAdmins = storedUsers.filter(
							(u) => u.role === "admin" && u.id !== user.id
						);
						if (otherAdmins.length === 0) {
							return alert(
								"Cannot delete this admin ‚Äî no other admin accounts exist. Create/assign another admin first."
							);
						}
					}

					// final confirm
					const confirmed = confirm(
						`Delete ${user.name} (${user.id}) ‚Äî this action cannot be undone. Proceed?`
					);
					if (!confirmed) return;

					// remove from storedUsers and persist
					const newList = storedUsers.filter((u) => u.id !== user.id);
					sessionStorage.setItem("users", JSON.stringify(newList));

					// Also set a flag so users.html (if it reads sessionStorage) can reflect the deletion immediately
					sessionStorage.setItem("deletedUserId", user.id);

					alert(
						`${user.name} has been deleted (demo). Returning to user list.`
					);
					window.location.href = "users.html";
					return;
				}

				// If we don't have a stored users array, fall back to strong confirmation and set deletedUserId
				if (user.role === "admin") {
					// we cannot check admin count; require extra explicit confirmation
					const extra = prompt(
						`This user is an admin. Type DELETE to confirm permanent deletion of ${user.name} (${user.id}):`
					);
					if (extra !== "DELETE") {
						return alert(
							"Deletion cancelled ‚Äî did not receive required confirmation."
						);
					}
				} else {
					const confirmed = confirm(
						`Delete ${user.name} (${user.id}) ‚Äî this action cannot be undone. Proceed?`
					);
					if (!confirmed) return;
				}

				// mark deletion for the list page to handle (or replace this with an API DELETE)
				sessionStorage.setItem("deletedUserId", user.id);
				alert(
					`${user.name} (${user.id}) marked deleted (demo). Returning to users list.`
				);

				// navigate back ‚Äî users.html can check deletedUserId on load and remove item from its array if desired
				window.location.href = "users.html";
			}

			// initialize
			(function init() {
				const user = loadUser();
				renderUserDetails(user);

				// persist selectedUser so users.html can reuse (convenience)
				sessionStorage.setItem("selectedUser", JSON.stringify(user));

				// allow Back button / link to return smoothly (keyboard)
				document
					.getElementById("backToList")
					.addEventListener("click", (e) => {
						sessionStorage.setItem(
							"selectedUser",
							JSON.stringify(user)
						);
					});

				// Wire the top logout buttons to simple demo handlers (parity)
				document
					.getElementById("logoutTop")
					?.addEventListener("click", () => alert("Logout (demo)"));
				document
					.getElementById("logoutSide")
					?.addEventListener("click", (e) => {
						e.preventDefault();
						alert("Logout (demo)");
					});

				// Edit-on-details main header button (same as edit)
				document
					.getElementById("editOnDetails")
					.addEventListener("click", () => {
						sessionStorage.setItem(
							"selectedUser",
							JSON.stringify(user)
						);
						window.location.href = "edit-user.html";
					});
			})();
		</script>
	</body>
</html>

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Event Ease ‚Äî Edit User</title>

		<!-- Fonts & Bootstrap (matching users.html) -->
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>

		<!-- Global design system CSS (keeps exact parity) -->
		<link rel="stylesheet" href="../style.css" />

		<style>
			/* Mirror styles / tokens from users.html so this page matches exactly */
			body {
				background: var(--bg-light);
				color: var(--text-dark);
				font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
					"Helvetica Neue", Arial;
			}
			.app-shell {
				height: calc(100vh - var(--header-height));
				overflow: hidden;
			}
			.app-main {
				flex: 1;
				padding: 32px;
				height: 100%;
				overflow-y: auto;
				background: var(--bg-light);
			}
			.page-header {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				gap: 16px;
				margin-bottom: 18px;
			}

			/* Keep same card style names from user.html */
			.card-compact,
			.card-edit {
				border-radius: 12px;
				background: var(--bg-surface);
				box-shadow: var(--shadow);
				border: 1px solid #e4e8f0;
				padding: 20px;
			}

			/* form layout tuned to look like the rest of app */
			.form-grid {
				display: grid;
				grid-template-columns: 1fr 320px;
				gap: 20px;
			}
			@media (max-width: 900px) {
				.form-grid {
					grid-template-columns: 1fr;
				}
			}

			.avatar-sm {
				width: 72px;
				height: 72px;
				border-radius: 999px;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 1.6rem;
				color: white;
				background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
			}

			.label {
				font-size: 13px;
				color: var(--muted, #6b7280);
				text-transform: uppercase;
				letter-spacing: 0.6px;
				margin-bottom: 6px;
			}

			.muted-small {
				color: var(--muted, #6b7280);
				font-size: 13px;
			}

			.role-chip {
				padding: 6px 12px;
				border-radius: 12px;
				font-weight: 600;
				font-size: 12px;
				display: inline-flex;
				align-items: center;
				gap: 6px;
				text-transform: capitalize;
				background: var(--primary-light);
				color: var(--primary-dark);
			}

			.danger-note {
				font-size: 13px;
				color: #7f1d1d;
				background: #fff1f2;
				border-radius: 8px;
				padding: 10px;
			}

			.actions .btn {
				min-width: 120px;
			}
		</style>
	</head>
	<body>
		<!-- TOPBAR (identical structure to users.html) -->
		<header class="topbar" role="banner">
			<div class="d-flex align-items-center gap-3">
				<button
					class="menu-toggle d-lg-none"
					id="sidebarToggle"
					aria-label="Open navigation"
				>
					‚ò∞
				</button>
				<a
					href="admin.html"
					class="d-flex align-items-center text-decoration-none"
					aria-label="Event Ease Home"
				>
					<div class="logo-mark">EE</div>
					<div
						style="
							margin-left: 10px;
							font-weight: 700;
							color: var(--text-dark);
						"
					>
						Event Ease
					</div>
				</a>
			</div>

			<div class="d-flex align-items-center gap-3">
				<div class="d-none d-md-block" style="min-width: 260px">
					<input
						id="globalSearch"
						class="form-control form-control-sm"
						placeholder="Search (users, emails, ids) ‚Äî /"
						aria-label="Global search"
						disabled
					/>
				</div>

				<div class="dropdown">
					<button
						class="btn d-flex align-items-center gap-2"
						data-bs-toggle="dropdown"
						aria-expanded="false"
					>
						<div
							class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
							style="width: 36px; height: 36px"
						>
							AD
						</div>
						<div class="d-none d-md-block text-start">
							<div style="font-weight: 600">Admin</div>
							<div class="muted small">admin@college.edu</div>
						</div>
					</button>
					<ul class="dropdown-menu dropdown-menu-end">
						<li>
							<a class="dropdown-item" href="profile.html"
								>Profile</a
							>
						</li>
						<li>
							<a class="dropdown-item" href="settings.html"
								>Settings</a
							>
						</li>
						<li><hr class="dropdown-divider" /></li>
						<li>
							<button
								class="dropdown-item text-danger"
								id="logoutTop"
							>
								Logout
							</button>
						</li>
					</ul>
				</div>
			</div>
		</header>

		<div class="app-shell d-flex">
			<!-- SIDEBAR (identical to users.html) -->
			<aside
				class="app-sidebar d-none d-lg-flex"
				id="sidebar"
				role="navigation"
				aria-label="Main navigation"
			>
				<nav class="sidebar-nav" role="menu">
					<a href="admin.html">üè† Home</a>
					<a href="users.html" class="active" aria-current="page"
						>üë• Users</a
					>
					<a href="events.html">üìÖ Events</a>
					<a href="add-event.html">‚ûï Add Event</a>
					<a href="reports.html">üìä Reports</a>
					<a href="profile.html">üë§ Profile</a>
				</nav>

				<div class="sidebar-footer">
					<a
						class="text-danger"
						href="#"
						id="logoutSide"
						style="display: block; margin-bottom: 12px"
						>üîí Logout</a
					>
					<div>v1.0 ‚Ä¢ ¬© <span id="yrEdit"></span></div>
				</div>
			</aside>

			<!-- MAIN -->
			<main class="app-main" id="main" role="main">
				<div class="page-header">
					<div>
						<h3>Edit user</h3>
						<div class="muted">
							Edit user profile, role, or delete the account.
						</div>
					</div>

					<div class="d-flex gap-2 align-items-center">
						<a
							href="users.html"
							class="btn btn-outline btn-sm"
							id="backToList"
							>‚Üê Back</a
						>
						<button class="btn btn-primary btn-sm" id="saveTop">
							Save
						</button>
					</div>
				</div>

				<div class="card-edit mb-3">
					<div id="editRoot">
						<!-- JS will render form here -->
						<div class="text-center py-5 text-muted">
							Loading form‚Ä¶
						</div>
					</div>
				</div>

				<div class="muted small">
					Tip: This is a prototype. Hook the form submit to your API
					(PATCH/PUT /api/users/:id) to persist changes.
				</div>
			</main>
		</div>

		<!-- Bootstrap JS -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			// parity with users.html
			document.getElementById("yrEdit").textContent =
				new Date().getFullYear();

			const CURRENT_ADMIN_ID = "U004";

			// helper utilities (same as other pages)
			function getQueryParam(name) {
				return new URLSearchParams(window.location.search).get(name);
			}
			function escapeHtml(text) {
				if (text === undefined || text === null) return "";
				return String(text)
					.replaceAll("&", "&amp;")
					.replaceAll("<", "&lt;")
					.replaceAll(">", "&gt;")
					.replaceAll('"', "&quot;")
					.replaceAll("'", "&#039;");
			}
			function initials(name) {
				if (!name) return "";
				const parts = name.trim().split(/\s+/);
				return (
					(parts[0]?.[0] || "") +
					(parts.length > 1 ? parts[parts.length - 1]?.[0] || "" : "")
				);
			}

			// demo dataset (reads from sessionStorage if users page saved it)
			const demoUsers = JSON.parse(
				sessionStorage.getItem("users") || "null"
			) || [
				{
					id: "U001",
					name: "Asha Sharma",
					email: "asha@college.edu",
					role: "student",
					active: true,
					phone: "+91-98xxxx",
					department: "CSE",
					createdAt: "2024-08-12",
					lastActive: "2025-12-04T09:30:00Z",
				},
				{
					id: "U002",
					name: "Ravi Patel",
					email: "ravi@college.edu",
					role: "teacher",
					active: true,
					phone: "+91-98xxxx",
					department: "ME",
					createdAt: "2023-11-20",
					lastActive: "2025-12-03T14:10:00Z",
				},
				{
					id: "U003",
					name: "Meera Singh",
					email: "meera@college.edu",
					role: "coordinator",
					active: false,
					phone: "+91-98xxxx",
					department: "EC",
					createdAt: "2022-04-05",
					lastActive: "2025-11-28T11:55:00Z",
				},
				{
					id: "U004",
					name: "Dev Admin",
					email: "admin@college.edu",
					role: "admin",
					active: true,
					phone: "+91-98xxxx",
					department: "Admin",
					createdAt: "2022-01-01",
					lastActive: "2025-12-05T08:10:00Z",
				},
			];

			// load selected user (sessionStorage selectedUser -> ?id -> demoUsers[0])
			function loadUserToEdit() {
				let user = null;
				const stored = sessionStorage.getItem("selectedUser");
				if (stored) {
					try {
						user = JSON.parse(stored);
					} catch (e) {
						user = null;
					}
				}
				if (!user) {
					const id = getQueryParam("id");
					if (id) user = demoUsers.find((u) => u.id === id);
				}
				if (!user) user = demoUsers[0];
				return user;
			}

			// render form matching users.html visual language
			function renderEditForm(user) {
				const root = document.getElementById("editRoot");
				root.innerHTML = `
          <form id="editForm" class="needs-validation" novalidate>
            <div class="form-grid">
              <div>
                <div class="d-flex gap-3 align-items-center mb-3">
                  <div class="avatar-sm">${escapeHtml(
						initials(user.name)
					)}</div>
                  <div>
                    <div style="font-weight:700">${escapeHtml(user.name)}</div>
                    <div class="muted-small">${escapeHtml(user.email)}</div>
                    <div class="muted-small">ID: ${escapeHtml(user.id)}</div>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Full name</label>
                  <input id="inpName" class="form-control" value="${escapeHtml(
						user.name
					)}" required />
                  <div class="invalid-feedback">Please enter a name</div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input id="inpEmail" type="email" class="form-control" value="${escapeHtml(
						user.email
					)}" required />
                  <div class="invalid-feedback">Please enter a valid email</div>
                </div>

                <div class="row g-2">
                  <div class="col-sm-6 mb-3">
                    <label class="form-label">Phone</label>
                    <input id="inpPhone" class="form-control" value="${escapeHtml(
						user.phone || ""
					)}" />
                  </div>
                  <div class="col-sm-6 mb-3">
                    <label class="form-label">Department</label>
                    <input id="inpDept" class="form-control" value="${escapeHtml(
						user.department || ""
					)}" />
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Role</label>
                  <select id="inpRole" class="form-select" required>
                    <option value="student">Student</option>
                    <option value="teacher">Teacher</option>
                    <option value="coordinator">Coordinator</option>
                    <option value="admin">Admin</option>
                  </select>
                  <div class="invalid-feedback">Please select a role</div>
                </div>

                <div class="form-check mb-3">
                  <input id="inpActive" class="form-check-input" type="checkbox" ${
						user.active ? "checked" : ""
					} />
                  <label class="form-check-label" for="inpActive">Active (can access account)</label>
                </div>

                <div class="mb-3">
                  <label class="form-label">Notes (internal)</label>
                  <textarea id="inpNotes" rows="3" class="form-control" placeholder="Optional internal notes"></textarea>
                </div>

                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary" id="saveBtn">Save changes</button>
                  <a href="user-details.html?id=${encodeURIComponent(
						user.id
					)}" class="btn btn-outline">Cancel</a>
                </div>
              </div>

              <div>
                <div class="mb-3">
                  <div class="label">Meta</div>
                  <div class="muted-small">Created: ${escapeHtml(
						user.createdAt || "‚Äî"
					)}</div>
                  <div class="muted-small mt-1">Last active: ${escapeHtml(
						user.lastActive || "‚Äî"
					)}</div>
                </div>

                <div class="mb-3">
                  <div class="label">Admin safeguards</div>
                  <div class="muted-small">If you change an admin's role or delete an admin, the system ensures at least one admin remains.</div>
                </div>

                <div class="danger-note mb-3">
                  <strong>Danger zone</strong>
                  <p class="mb-1" style="margin-top:6px;">You cannot demote the only remaining admin. If you attempt to do so, the form will prevent it.</p>
                </div>

                <div>
                  <button type="button" class="btn btn-danger w-100" id="deleteInlineBtn">Delete user</button>
                </div>
              </div>
            </div>
          </form>
        `;

				// set role value after render
				document.getElementById("inpRole").value =
					user.role || "student";

				// top save button mirrors form submit
				document
					.getElementById("saveTop")
					.addEventListener("click", () => {
						document.getElementById("saveBtn").click();
					});

				// form submission
				const form = document.getElementById("editForm");
				form.addEventListener(
					"submit",
					function (e) {
						e.preventDefault();
						e.stopPropagation();

						if (!form.checkValidity()) {
							form.classList.add("was-validated");
							return;
						}

						const id = user.id;
						const name = document
							.getElementById("inpName")
							.value.trim();
						const email = document
							.getElementById("inpEmail")
							.value.trim();
						const phone = document
							.getElementById("inpPhone")
							.value.trim();
						const dept = document
							.getElementById("inpDept")
							.value.trim();
						const role = document.getElementById("inpRole").value;
						const active =
							!!document.getElementById("inpActive").checked;
						const notes = document
							.getElementById("inpNotes")
							.value.trim();

						// Admin demotion safeguard
						if (user.role === "admin" && role !== "admin") {
							const adminCount = demoUsers.filter(
								(u) => u.role === "admin" && u.id !== user.id
							).length;
							if (adminCount === 0) {
								return alert(
									"Cannot demote the only remaining admin. Assign another admin before changing this user."
								);
							}
						}

						// update demoUsers and persist
						const idx = demoUsers.findIndex((u) => u.id === id);
						const updated = {
							...(idx >= 0 ? demoUsers[idx] : {}),
							id,
							name,
							email,
							phone,
							department: dept,
							role,
							active,
							notes,
						};

						if (idx >= 0) demoUsers[idx] = updated;
						else demoUsers.push(updated);

						sessionStorage.setItem(
							"users",
							JSON.stringify(demoUsers)
						);
						sessionStorage.setItem(
							"selectedUser",
							JSON.stringify(updated)
						);

						// In production: call PATCH /api/users/:id then redirect on success
						alert("Saved (demo). Returning to details.");
						window.location.href = `user-details.html?id=${encodeURIComponent(
							id
						)}`;
					},
					{ once: false }
				);

				// delete inline behaviour
				document
					.getElementById("deleteInlineBtn")
					.addEventListener("click", () => {
						if (user.id === CURRENT_ADMIN_ID) {
							return alert(
								"You cannot delete your own admin account from this interface."
							);
						}

						if (user.role === "admin") {
							const otherAdmins = demoUsers.filter(
								(u) => u.role === "admin" && u.id !== user.id
							);
							if (otherAdmins.length === 0) {
								return alert(
									"Cannot delete this admin ‚Äî no other admin accounts exist. Create/assign another admin first."
								);
							}
						}

						const confirmed = confirm(
							`Delete ${user.name} (${user.id}) ‚Äî this action cannot be undone. Proceed?`
						);
						if (!confirmed) return;

						const newList = demoUsers.filter(
							(u) => u.id !== user.id
						);
						sessionStorage.setItem(
							"users",
							JSON.stringify(newList)
						);
						sessionStorage.setItem("deletedUserId", user.id);

						alert(
							`${user.name} deleted (demo). Returning to users list.`
						);
						window.location.href = "users.html";
					});
			}

			// initialize
			(function init() {
				const user = loadUserToEdit();
				renderEditForm(user);

				// wire top logout items for parity
				document
					.getElementById("logoutTop")
					?.addEventListener("click", () => alert("Logout (demo)"));
				document
					.getElementById("logoutSide")
					?.addEventListener("click", (e) => {
						e.preventDefault();
						alert("Logout (demo)");
					});
			})();
		</script>
	</body>
</html>
